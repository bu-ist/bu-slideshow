!function(e){function i(i,t){e("#bu-slideshow-editform-submit").prop("disabled","disabled"),window.reindexingSlides=!0;var s=/bu_slides\[([0-9]*)\](.*)/,l="";e(".bu-slideshow-slide").each(function(i,t){e(t).find("input, textarea, select").each(function(t,o){var d=e(o);l=d.attr("name"),l=l.replace(s,"bu_slides["+i+"]$2"),d.attr("name",l)})}),e("#bu-slideshow-editform-submit").prop("disabled",!1),window.reindexingSlides=!1}function t(i,t){var s=t.item.height(),l=t.item.width();e(".sortable-placeholder").outerHeight(s).width(l)}function s(i){var t={action:"bu_add_slide",order:i};e.post(ajaxurl,t,function(i){if(!i)return void o(buSlideshowLocalAdmin.addSlideFailError,e("#bu-slideshow-slidelist"));var t=e(i);t.appendTo("#bu-slideshow-slidelist ul"),l(t.find(".bu-slideshow-add-img")),e("#bu-slideshow-slidelist ul li:last-child .bu-slide-edit-container").slideDown()})}function l(i){imgHref=i.attr("href")+"&width=640&height="+.9*e(window).height(),i.attr("href",imgHref)}function o(i,t,s){"undefined"==typeof s&&(s=!1),e(".error").remove();var l='<div class="error"><p>'+i+"</p></div>";s?t.prepend(l):t.append(l),setTimeout(function(){e(".error").fadeOut(500)},1e3)}e(function(){var d=e("#bu-slideshow-newform"),n=e("#bu-slideshow-manage"),a=e("#bu-slideshow-slides"),r=e("#bu-slideshow-edit");if(d.length&&d.on("submit",function(){var i=e("#bu-new-slideshow-name").val();return!!i.length||(o("You must enter a name.",d),!1)}),n.length&&a.length){var u=function(i){var t={};if(t.container=a,t.list=e(i.list),!t.list.length)throw TypeError("Invalid element supplied to slideshow manager.");t.nonce=e("#bu_slideshow_nonce").val(),t.numShows=function(){return t.list.find("li").length},t.addEmptyMsg=function(){t.getUrl("add_url",function(e){var i="<li><p>"+buSlideshowLocalAdmin.noSlideshowsMsg+'</p><p><a class="button" href="'+e+'">'+buSlideshowLocalAdmin.addButtonText+"</a></p></li>";t.list.append(i)})},t.getUrl=function(i,t){var s={action:"bu_slideshow_get_url",url:i};e.post(ajaxurl,s,function(e){t(e)})},t.list.on("click",".bu-slideshow-delete",function(){var i=confirm(buSlideshowLocalAdmin.deleteConfirm);if(i){var s,l,o=e(this);s=o.attr("data-slideshow-id"),l={action:"bu_delete_slideshow",id:s,bu_slideshow_nonce:t.nonce},e.post(ajaxurl,l,function(e){t.deleteResponse(o,e)})}return!1}),t.deleteResponse=function(e,i){return i&&"0"!==i?(e.parent().parent("li").remove(),t.container.find(".error").remove(),t.numShows()||t.addEmptyMsg(),void 0):(o(buSlideshowLocalAdmin.deleteError,t.container),!1)}};u({list:"#bu-slideshow-manage"})}if(e("#bu_slideshow_modal_button").length&&"function"==typeof BuModal&&"function"==typeof SlideshowSelector){var h=new BuModal({el:"#bu_slideshow_modal_wrap",height:"80%"}),m=new SlideshowSelector("#bu_slideshow_modal_wrap .bu-slideshow-selector");e("#bu_slideshow_modal_button").on("click",function(){h.open()}),e("#bu_slideshow_modal_wrap").on("click","#bu_insert_slideshow",function(e){var i,t;return m.ui.parent().find(".error").remove(),i=m.getOptions(),parseInt(i.show_id)?(t='[bu_slideshow show_id="'+i.show_id+'" show_nav="'+i.show_nav+'" transition="'+i.transition+'" nav_style="'+i.nav_style+'" autoplay="'+i.autoplay+'" transition_delay="'+i.transition_delay+'" width="'+i.width+' shuffle="'+i.shuffle+'"]',window.send_to_editor("<br />"+t+"<br />"),m.reset(),h.close(),!1):(o(buSlideshowLocalAdmin.noneSelectedError,m.ui.parent()),!1)})}r.length&&(e(".bu-slideshow-slide:first-child").addClass("open"),e("#bu-slideshow-slidelist").on("click",".bu-slide-expand",function(){var i=e(this).parents(".bu-slideshow-slide").first(),t=i.find(".bu-slide-edit-container");return i.hasClass("open")?(i.removeClass("open"),t.slideUp(300)):(i.addClass("open"),t.slideDown(300)),!1}),e("#bu-slideshow-slidelist").on("keyup",".bu-slideshow-title-input",function(){var i=e(this);i.parents(".bu-slideshow-slide").find(".bu-slide-title").text(i.val())}),e("#bu-slideshow-editform").on("submit",function(){var i=e("#bu_slideshow_name").val().replace(" ","");return i?!window.reindexingSlides:(o(buSlideshowLocalAdmin.emptyNameError,e(this)),!1)}),e("#bu-slideshow-slidelist ul").sortable({stop:i,placeholder:"sortable-placeholder",start:t}),e("#bu-slideshow-add-slide").on("click",function(){var e=r.find("#bu-slideshow-slidelist li").length;return s(e),!1}),e("#bu-slideshow-slidelist").on("click",".bu-slide-delete-button",function(){return confirm(buSlideshowLocalAdmin.deleteConfirmSlide)&&(e(this).parents().parent(".bu-slideshow-slide").remove(),i()),!1}),window.buUploaders={init:function(i){var t=e(i);if(!t.length)throw new TypeError("No valid button identified.");this.slide=t.parents(".bu-slideshow-slide"),this.populateFields()},populateFields:function(){this.addButton=this.slide.find(".bu-slideshow-add-img"),this.removeButton=this.slide.find(".bu-slideshow-remove-img"),this.imgIdField=this.slide.find(".bu-slideshow-img-id"),this.imgSizeField=this.slide.find(".bu-slideshow-img-size"),this.imgMeta=this.slide.find(".bu-slide-meta"),this.thumbContainers=this.slide.find(".bu-slide-thumb, .bu-slide-header-thumb")},select:function(){this.newHandleImageSelect()},remove:function(){this.thumbContainers.each(function(i,t){e(t).find("img").remove()}),this.imgIdField.val(""),this.imgSizeField.val(""),this.imgMeta.hide(),this.removeButton.hide()},handleImgThumbResponse:function(i){var t,s;i&&"0"!==i?(this.thumbContainers.each(function(l,o){s=e(o),t=s.find("img"),t.length?t.replaceWith(i):s.append(i)}),this.removeButton.show()):o(buSlideshowLocalAdmin.thumbFailError,this.slide.find(".bu-slide-edit-container"),!0)},newHandleImageSelect:function(){var e=this;"object"!=typeof buUploadFrame&&(e.modifyWPSelectFrame(),buUploadFrame=wp.media.frames.bu_slideshow_frame=wp.media({frame:"select",state:"bu-slideshow-image",states:[new wp.media.controller.BuSlideshowImage],button:{text:buSlideshowLocalAdmin.mediaUploadButton},library:{type:"image"}}),buUploadFrame.state("bu-slideshow-image").on("select",function(){var i,t,s;i=this.get("selection").first(),t=this.display(i).attributes,s=i.toJSON().id,e.getImgThumb(s),e.setImageDetails(s,t.size),e.slide.find(".bu-slide-meta").hide()})),buUploadFrame.open()},modifyWPSelectFrame:function(){wp.media.controller.BuSlideshowImage=wp.media.controller.Library.extend({defaults:_.defaults({id:"bu-slideshow-image",library:wp.media.query({type:"image"}),multiple:!1,priority:60,displaySettings:!0,displayUserSettings:!0,title:buSlideshowLocalAdmin.mediaUploadTitle},wp.media.controller.Library.prototype.defaults)})},getImgThumb:function(i){var t,s=this;t={action:"bu_get_slide_thumb",image_id:i},e.post(ajaxurl,t,function(e){s.handleImgThumbResponse(e)})},setImageDetails:function(e,i){this.imgIdField.val(e),this.imgSizeField.val(i)}},e("#bu-slideshow-slidelist").on("click",".bu-slideshow-add-img",function(e){return window.buUploaders.init(this),window.buUploaders.select(),!1}),e("#bu-slideshow-slidelist").on("click",".bu-slideshow-remove-img",function(){return window.buUploaders.init(this),window.buUploaders.remove(),!1}),e("#bu-slideshow-slidelist .bu-slideshow-add-img").each(function(){l(e(this))})),e("#bu_slideshow_show_nav").on("click",function(){e(".bu_slideshow_nav_style").toggle()})})}(jQuery);