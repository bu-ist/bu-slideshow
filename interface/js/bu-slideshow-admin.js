(function(a){function m(d,f){a("#bu-slideshow-editform-submit").prop("disabled","disabled");window.reindexingSlides=!0;var e=/bu_slides\[([0-9]*)\](.*)/,g="";a(".bu-slideshow-slide").each(function(d,f){a(f).find("input, textarea").each(function(b,c){var h=a(c);g=h.attr("name");g=g.replace(e,"bu_slides["+d+"]$2");h.attr("name",g)})});a("#bu-slideshow-editform-submit").prop("disabled",!1);window.reindexingSlides=!1}function r(d,f){var e=f.item.height(),g=f.item.width();a(".sortable-placeholder").outerHeight(e).width(g)}
function s(d){a.post(ajaxurl,{action:"bu_add_slide",order:d},function(d){d?(d=a(d),d.appendTo("#bu-slideshow-slidelist ul"),p(d.find(".bu-slideshow-add-img")),a("#bu-slideshow-slidelist ul li:last-child .bu-slide-edit-container").slideDown()):k(buSlideshowLocalAdmin.addSlideFailError,a("#bu-slideshow-slidelist"))})}function p(a){imgHref=a.attr("href")+"&width=640&height="+modalHeight;a.attr("href",imgHref)}function k(d,f,e){"undefined"===typeof e&&(e=!1);a(".error").remove();d='<div class="error"><p>'+
d+"</p></div>";e?f.prepend(d):f.append(d);setTimeout(function(){a(".error").fadeOut(500)},1E3)}a(function(){var d=a("#bu-slideshow-newform"),f=a("#bu-slideshow-manage"),e=a("#bu-slideshow-slides"),g=a("#bu-slideshow-edit");if(d.length)d.on("submit",function(){return a("#bu-new-slideshow-name").val().length?!0:(k("You must enter a name.",d),!1)});f.length&&e.length&&function(b){var c={};c.container=e;c.list=a(b.list);if(!c.list.length)throw TypeError("Invalid element supplied to slideshow manager.");
c.nonce=a("#bu_slideshow_nonce").val();c.numShows=function(){return c.list.find("li").length};c.addEmptyMsg=function(){c.getUrl("add_url",function(b){c.list.append("<li><p>"+buSlideshowLocalAdmin.noSlideshowsMsg+'</p><p><a class="button" href="'+b+'">'+buSlideshowLocalAdmin.addButtonText+"</a></p></li>")})};c.getUrl=function(b,c){a.post(ajaxurl,{action:"bu_slideshow_get_url",url:b},function(b){c(b)})};c.list.on("click",".bu-slideshow-delete",function(){if(confirm(buSlideshowLocalAdmin.deleteConfirm)){var b=
a(this),q;q={action:"bu_delete_slideshow",id:b.attr("data-slideshow-id"),bu_slideshow_nonce:c.nonce};a.post(ajaxurl,q,function(a){c.deleteResponse(b,a)})}return!1});c.deleteResponse=function(b,a){if(a&&"0"!==a)b.parent().parent("li").remove(),c.container.find(".error").remove(),c.numShows()||c.addEmptyMsg();else return k(buSlideshowLocalAdmin.deleteError,c.container),!1}}({list:"#bu-slideshow-manage"});if(a("#bu_slideshow_modal_button").length&&"function"===typeof BuModal&&"function"===typeof SlideshowSelector){var n=
new BuModal({el:"#bu_slideshow_modal_wrap"}),l=new SlideshowSelector("#bu_slideshow_modal_wrap .bu-slideshow-selector");a("#bu_slideshow_modal_button").on("click",function(){n.open()});a("#bu_slideshow_modal_wrap").on("click","#bu_insert_slideshow",function(b){l.ui.parent().find(".error").remove();b=l.getOptions();if(!parseInt(b.show_id))return k(buSlideshowLocalAdmin.noneSelectedError,l.ui.parent()),!1;window.send_to_editor("<br />"+("auto"===b.width?'[bu_slideshow show_id="'+b.show_id+'" show_nav="'+
b.show_nav+'" transition="'+b.transition+'" nav_style="'+b.nav_style+'" autoplay="'+b.autoplay+'" transition_delay="'+b.transition_delay+'" width="'+b.width+'"]':'[bu_slideshow show_id="'+b.show_id+'" show_nav="'+b.show_nav+'" transition="'+b.transition+'" nav_style="'+b.nav_style+'" autoplay="'+b.autoplay+'" transition_delay="'+b.transition_delay+'" width="'+b.width+'" align="'+b.align+'"]')+"<br />");l.reset();n.close();return!1})}g.length&&(a(window).height(),a(".bu-slideshow-slide:first-child .bu-slide-control").addClass("open"),
a("#bu-slideshow-slidelist").on("click",".bu-slide-expand",function(){var b=a(this),c;c=b.parents(".bu-slideshow-slide").find(".bu-slide-edit-container");b.hasClass("open")?(b.removeClass("open"),c.slideUp(300)):(b.addClass("open"),c.slideDown(300));return!1}),a("#bu-slideshow-slidelist").on("keyup",".bu-slideshow-title-input",function(){var b=a(this);b.parents(".bu-slideshow-slide").find(".bu-slide-title").text(b.val())}),a("#bu-slideshow-editform").on("submit",function(){return a("#bu_slideshow_name").val().replace(" ",
"")?!window.reindexingSlides:(k(buSlideshowLocalAdmin.emptyNameError,a(this)),!1)}),a("#bu-slideshow-slidelist ul").sortable({stop:m,placeholder:"sortable-placeholder",start:r}),a("#bu-slideshow-add-slide").on("click",function(){var b=g.find("#bu-slideshow-slidelist li").length;s(b);return!1}),a("#bu-slideshow-slidelist").on("click",".bu-slide-delete-button",function(){confirm(buSlideshowLocalAdmin.deleteConfirmSlide)&&(a(this).parents().parent(".bu-slideshow-slide").remove(),m());return!1}),window.buUploaders=
{newEditor:window.wp&&window.wp.media?!0:!1,init:function(b){b=a(b);if(!b.length)throw new TypeError("No valid button identified.");this.slide=b.parents(".bu-slideshow-slide");this.populateFields()},populateFields:function(){this.addButton=this.slide.find(".bu-slideshow-add-img");this.removeButton=this.slide.find(".bu-slideshow-remove-img");this.imgIdField=this.slide.find(".bu-slideshow-img-id");this.imgSizeField=this.slide.find(".bu-slideshow-img-size");this.thumbContainers=this.slide.find(".bu-slide-thumb, .bu-slide-header-thumb")},
select:function(){this.newEditor?this.newHandleImageSelect():this.oldHandleImageSelect()},remove:function(){this.thumbContainers.each(function(b,c){a(c).find("img").remove()});this.imgIdField.val("");this.imgSizeField.val("");this.removeButton.hide()},oldHandleImageSelect:function(){var b=this;window.send_to_editor=function(c){var h,d;a("body").append("<div id='slideshow_image_added' style='display:none;'>"+c+"</div>");h=a("#slideshow_image_added").find("img").attr("class");d=/wp-image-([0-9]*)/i;
(d=d.exec(h))?(c=d[1],d=/size-([a-zA-Z]*)/i,d=d.exec(h),h=d[1],d?(b.setImageDetails(c,h),c={action:"bu_get_slide_thumb",image_id:c},a.post(ajaxurl,c,function(a){b.handleImgThumbResponse(a)}),a("#slideshow_image_added").remove(),tb_remove()):(tb_remove(),k(buSlideshowLocalAdmin.imageFail,b.slide.find(".bu-slide-edit-container"),!0))):(tb_remove(),k(buSlideshowLocalAdmin.imageFail,b.slide.find(".bu-slide-edit-container"),!0))}},handleImgThumbResponse:function(b){var c,d;(b=a.parseJSON(b))&&"0"!==b?
(this.thumbContainers.each(function(f,e){d=a(e);c=d.find("img");c.length?c.attr("src",b[0]):d.append('<img src="'+b[0]+'" alt="'+buSlideshowLocalAdmin.thumbAltText+'" />')}),this.removeButton.show()):k(buSlideshowLocalAdmin.thumbFailError,this.slide.find(".bu-slide-edit-container"),!0)},newHandleImageSelect:function(){var b=this;if("object"!==typeof buUploadFrame){var a=wp.media.view.MediaFrame.Select.prototype.browseContent;b.modifyWPSelectFrame();buUploadFrame=wp.media.frames.bu_slideshow_frame=
wp.media({multiple:!1,title:buSlideshowLocalAdmin.mediaUploadTitle,button:{text:buSlideshowLocalAdmin.mediaUploadButton},library:{type:"image"}});wp.media.view.MediaFrame.Select.prototype.browseContent=a;buUploadFrame.on("select",function(){var a,c;c=buUploadFrame.state();a=c.get("selection").first();c=c.display(a).attributes;a=a.toJSON().id;b.getImgThumb(a);b.setImageDetails(a,c.size)})}buUploadFrame.open()},modifyWPSelectFrame:function(){wp.media.view.MediaFrame.Select.prototype.browseContent=function(a){var c=
this.state(),d=c.get("selection");this.$el.removeClass("hide-toolbar");a.view=new wp.media.view.AttachmentsBrowser({controller:this,collection:c.get("library"),model:c,filters:c.get("filterable"),display:!0,selection:d,sortable:!0,search:!1,dragInfo:!0,AttachmentView:wp.media.view.Attachment.EditLibrary})}},getImgThumb:function(b){var c=this;a.post(ajaxurl,{action:"bu_get_slide_thumb",image_id:b},function(a){c.handleImgThumbResponse(a)})},setImageDetails:function(a,c){this.imgIdField.val(a);this.imgSizeField.val(c)}},
a("#bu-slideshow-slidelist").on("click",".bu-slideshow-add-img",function(a){window.buUploaders.init(this);window.buUploaders.select();return!1}),a("#bu-slideshow-slidelist").on("click",".bu-slideshow-remove-img",function(){window.buUploaders.init(this);window.buUploaders.remove();return!1}),a("#bu-slideshow-slidelist .bu-slideshow-add-img").each(function(){p(a(this))}));a("#bu_slideshow_show_nav").on("click",function(){a(".bu_slideshow_nav_style").toggle()})})})(jQuery);