jQuery(document).ready(function($){function displayError(msg,target,pre){typeof pre=="undefined"&&(pre=!1);$(".error").remove();var html='<div class="error"><p>'+msg+"</p></div>";pre?target.prepend(html):target.append(html);setTimeout(function(){$(".error").fadeOut(500)},1e3)}var newSlideshowForm=$("#bu-slideshow-newform"),slideShowList=$("#bu-slideshow-manage"),slidesContainer=$("#bu-slideshow-slides"),slideEditor=$("#bu-slideshow-edit"),manageUrl="admin.php?page=bu-slideshow";newSlideshowForm.length&&newSlideshowForm.on("submit",function(){var name=$("#bu-new-slideshow-name").val();if(!name.length){displayError("You must enter a name.",newSlideshowForm);return!1}return!0});if(slideShowList.length&&slidesContainer.length){var slideShowMgr=function(args){var that={};that.container=slidesContainer;that.list=$(args.list);if(!that.list.length)throw TypeError("Invalid element supplied to slideshow manager.");that.nonce=$("#bu_slideshow_nonce").val();that.numShows=function(){return that.list.find("li").length};that.addEmptyMsg=function(){that.getUrl("add_url",function(addUrl){var html="<li><p>"+buSlideshowLocalAdmin.noSlideshowsMsg+"</p>"+'<p><a class="button" href="'+addUrl+'">'+buSlideshowLocalAdmin.addButtonText+"</a></p></li>";that.list.append(html)})};that.getUrl=function(url,cb){var data={action:"bu_slideshow_get_url",url:url};$.post(ajaxurl,data,function(response){cb(response)})};that.list.on("click",".bu-slideshow-delete",function(){var result=confirm(buSlideshowLocalAdmin.deleteConfirm);if(result){var $this=$(this),showId,data;showId=$this.attr("data-slideshow-id");data={action:"bu_delete_slideshow",id:showId,bu_slideshow_nonce:that.nonce};$.post(ajaxurl,data,function(response){that.deleteResponse($this,response)})}return!1});that.deleteResponse=function(el,r){if(!r||r==="0"){displayError(buSlideshowLocalAdmin.deleteError,that.container);return!1}el.parent().parent("li").remove();that.container.find(".error").remove();that.numShows()||that.addEmptyMsg()}};slideShowMgr({list:"#bu-slideshow-manage"})}if($("#bu_slideshow_modal_button").length&&typeof BuModal=="function"&&typeof SlideshowSelector=="function"){var modal=new BuModal({el:"#bu_slideshow_modal_wrap"}),selector=new SlideshowSelector("#bu_slideshow_modal_wrap .bu-slideshow-selector");$("#bu_slideshow_modal_button").on("click",function(){modal.open()});$("#bu_slideshow_modal_wrap").on("click","#bu_insert_slideshow",function(e){var options,html;selector.ui.parent().find(".error").remove();options=selector.getOptions();if(!parseInt(options.show_id)){displayError(buSlideshowLocalAdmin.noneSelectedError,selector.ui.parent());return!1}html='[bu_slideshow show_id="'+options.show_id+'" show_nav="'+options.show_nav+'" transition="'+options.transition+'" nav_style="'+options.nav_style+'" autoplay="'+options.autoplay+'" width="'+options.width+'"]';window.send_to_editor("<br />"+html+"<br />");selector.reset();modal.close();return!1})}if(slideEditor.length){var modalHeight,imgHref;modalHeight=$(window).height()*.9;function reindexSlides(event,ui){$("#bu-slideshow-editform-submit").prop("disabled","disabled");window.reindexingSlides=!0;var regEx=/bu_slides\[([0-9]*)\](.*)/,name="";$(".bu-slideshow-slide").each(function(index,el){$(el).find("input, textarea").each(function(i,e){var $e=$(e);name=$e.attr("name");name=name.replace(regEx,"bu_slides["+index+"]$2");$e.attr("name",name)})});$("#bu-slideshow-editform-submit").prop("disabled",!1);window.reindexingSlides=!1}function createPlaceholder(event,ui){var h=ui.item.height(),w=ui.item.width();$(".sortable-placeholder").outerHeight(h).width(w)}function addSlide(order){var data={action:"bu_add_slide",order:order};$.post(ajaxurl,data,function(response){if(!response){displayError(buSlideshowLocalAdmin.addSlideFailError,$("#bu-slideshow-slidelist"));return}var r=$(response);r.find(".bu-slide-edit-container").css("display","none");r.appendTo("#bu-slideshow-slidelist ul");setModalHeight(r.find(".bu-slideshow-add-img"))})}function setModalHeight($link){imgHref=$link.attr("href")+"&width=640&height="+modalHeight;$link.attr("href",imgHref)}$(".bu-slide-edit-container").hide();$("#bu-slideshow-slidelist").on("click",".bu-slide-expand",function(){var clicked=$(this),editor;editor=clicked.parents(".bu-slideshow-slide").find(".bu-slide-edit-container");if(clicked.hasClass("open")){clicked.removeClass("open");editor.slideUp(300)}else{clicked.addClass("open");editor.slideDown(300)}return!1});$("#bu-slideshow-slidelist").on("keyup",".bu-slideshow-title-input",function(){var input=$(this);input.parents(".bu-slideshow-slide").find(".bu-slide-title").text(input.val())});$("#bu-slideshow-editform").on("submit",function(){var name=$("#bu_slideshow_name").val().replace(" ","");if(!name){displayError(buSlideshowLocalAdmin.emptyNameError,$(this));return!1}return!window.reindexingSlides});$("#bu-slideshow-slidelist ul").sortable({stop:reindexSlides,placeholder:"sortable-placeholder",start:createPlaceholder});$("#bu-slideshow-add-slide").on("click",function(){var order=slideEditor.find("#bu-slideshow-slidelist li").length;addSlide(order);return!1});$("#bu-slideshow-slidelist").on("click",".bu-slide-delete-button",function(){$(this).parents().parent(".bu-slideshow-slide").remove();reindexSlides();return!1});window.buUploaders={newEditor:window.wp&&window.wp.media?!0:!1,init:function(button){var $button=$(button);if(!$button.length)throw new TypeError("No valid button identified.");this.slide=$button.parents(".bu-slideshow-slide");this.populateFields()},populateFields:function(){this.addButton=this.slide.find(".bu-slideshow-add-img");this.removeButton=this.slide.find(".bu-slideshow-remove-img");this.imgIdField=this.slide.find(".bu-slideshow-img-id");this.imgSizeField=this.slide.find(".bu-slideshow-img-size");this.thumbContainers=this.slide.find(".bu-slide-thumb, .bu-slide-header-thumb")},select:function(){this.newEditor?this.newHandleImageSelect():this.oldHandleImageSelect()},remove:function(){this.thumbContainers.each(function(index,el){$(el).find("img").remove()});this.imgIdField.val("");this.imgSizeField.val("");this.removeButton.hide()},oldHandleImageSelect:function(){var that=this;window.send_to_editor=function(html){var imgClass,regex,r,imgId,imgSize,data,thumb;imgClass=$("img",html).attr("class");regex=/wp-image-([0-9]*)/i;r=regex.exec(imgClass);imgId=r[1];regex=/size-([a-zA-Z]*)/i;r=regex.exec(imgClass);imgSize=r[1];that.setImageDetails(imgId,imgSize);data={action:"bu_get_slide_thumb",image_id:imgId};$.post(ajaxurl,data,function(response){that.handleImgThumbResponse(response)});tb_remove()}},handleImgThumbResponse:function(response){var thumb,$el;response=$.parseJSON(response);if(!response||response==="0")displayError(buSlideshowLocalAdmin.thumbFailError,this.slide.find(".bu-slide-edit-container"),!0);else{this.thumbContainers.each(function(index,el){$el=$(el);thumb=$el.find("img");thumb.length?thumb.attr("src",response[0]):$el.append('<img src="'+response[0]+'" alt="'+buSlideshowLocalAdmin.thumbAltText+'" />')});this.removeButton.show()}},newHandleImageSelect:function(){var that=this;if(typeof buUploadFrame!="object"){var oldBrowseContent=wp.media.view.MediaFrame.Select.prototype.browseContent;that.modifyWPSelectFrame();buUploadFrame=wp.media.frames.bu_slideshow_frame=wp.media({multiple:!1,title:buSlideshowLocalAdmin.mediaUploadTitle,button:{text:buSlideshowLocalAdmin.mediaUploadButton},library:{type:"image"}});wp.media.view.MediaFrame.Select.prototype.browseContent=oldBrowseContent;buUploadFrame.on("select",function(){var img,props,state,imgId;state=buUploadFrame.state();img=state.get("selection").first();props=state.display(img).attributes;imgId=img.toJSON().id;that.getImgThumb(imgId);that.setImageDetails(imgId,props.size)})}buUploadFrame.open()},modifyWPSelectFrame:function(){wp.media.view.MediaFrame.Select.prototype.browseContent=function(content){var state=this.state(),selection=state.get("selection");this.$el.removeClass("hide-toolbar");content.view=new wp.media.view.AttachmentsBrowser({controller:this,collection:state.get("library"),model:state,sortable:state.get("sortable"),search:state.get("searchable"),filters:state.get("filterable"),display:!0,dragInfo:state.get("dragInfo"),selection:selection,sortable:!0,search:!1,dragInfo:!0,AttachmentView:wp.media.view.Attachment.EditLibrary})}},getImgThumb:function(imgId){var that=this,data;data={action:"bu_get_slide_thumb",image_id:imgId};$.post(ajaxurl,data,function(response){that.handleImgThumbResponse(response)})},setImageDetails:function(id,size){this.imgIdField.val(id);this.imgSizeField.val(size)}};$("#bu-slideshow-slidelist").on("click",".bu-slideshow-add-img",function(e){window.buUploaders.init(this);window.buUploaders.select();return!1});$("#bu-slideshow-slidelist").on("click",".bu-slideshow-remove-img",function(){window.buUploaders.init(this);window.buUploaders.remove();return!1});$("#bu-slideshow-slidelist .bu-slideshow-add-img").each(function(){setModalHeight($(this))})}});