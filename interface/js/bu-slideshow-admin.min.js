!function(a){function b(b,c){a("#bu-slideshow-editform-submit").prop("disabled","disabled"),window.reindexingSlides=!0;var d=/bu_slides\[([0-9]*)\](.*)/,e="";a(".bu-slideshow-slide").each(function(b,c){a(c).find("input, textarea, select").each(function(c,f){var g=a(f);e=g.attr("name"),e=e.replace(d,"bu_slides["+b+"]$2"),g.attr("name",e)})}),a("#bu-slideshow-editform-submit").prop("disabled",!1),window.reindexingSlides=!1}function c(b,c){var d=c.item.height(),e=c.item.width();a(".sortable-placeholder").outerHeight(d).width(e)}function d(b){var c={action:"bu_add_slide",order:b};a.post(ajaxurl,c,function(b){if(!b)return void f(buSlideshowLocalAdmin.addSlideFailError,a("#bu-slideshow-slidelist"));var c=a(b);c.appendTo("#bu-slideshow-slidelist ul"),e(c.find(".bu-slideshow-add-img")),a("#bu-slideshow-slidelist ul li:last-child .bu-slide-edit-container").slideDown()})}function e(b){imgHref=b.attr("href")+"&width=640&height="+.9*a(window).height(),b.attr("href",imgHref)}function f(b,c,d){void 0===d&&(d=!1),a(".error").remove();var e='<div class="error"><p>'+b+"</p></div>";d?c.prepend(e):c.append(e),setTimeout(function(){a(".error").fadeOut(500)},1e3)}a(function(){var g=a("#bu-slideshow-newform"),h=a("#bu-slideshow-manage"),i=a("#bu-slideshow-slides"),j=a("#bu-slideshow-edit");if(g.length&&g.on("submit",function(){return!!a("#bu-new-slideshow-name").val().length||(f("You must enter a name.",g),!1)}),h.length&&i.length){(function(b){var c={};if(c.container=i,c.list=a(b.list),!c.list.length)throw TypeError("Invalid element supplied to slideshow manager.");c.nonce=a("#bu_slideshow_nonce").val(),c.numShows=function(){return c.list.find("li").length},c.addEmptyMsg=function(){c.getUrl("add_url",function(a){var b="<li><p>"+buSlideshowLocalAdmin.noSlideshowsMsg+'</p><p><a class="button" href="'+a+'">'+buSlideshowLocalAdmin.addButtonText+"</a></p></li>";c.list.append(b)})},c.getUrl=function(b,c){var d={action:"bu_slideshow_get_url",url:b};a.post(ajaxurl,d,function(a){c(a)})},c.list.on("click",".bu-slideshow-delete",function(){if(confirm(buSlideshowLocalAdmin.deleteConfirm)){var b,d,e=a(this);b=e.attr("data-slideshow-id"),d={action:"bu_delete_slideshow",id:b,bu_slideshow_nonce:c.nonce},a.post(ajaxurl,d,function(a){c.deleteResponse(e,a)})}return!1}),c.deleteResponse=function(a,b){if(!b||"0"===b)return f(buSlideshowLocalAdmin.deleteError,c.container),!1;a.parent().parent("li").remove(),c.container.find(".error").remove(),c.numShows()||c.addEmptyMsg()}})({list:"#bu-slideshow-manage"})}if(a("#bu_slideshow_modal_button").length&&"function"==typeof BuModal&&"function"==typeof SlideshowSelector){var k=new BuModal({el:"#bu_slideshow_modal_wrap",height:"80%"}),l=new SlideshowSelector("#bu_slideshow_modal_wrap .bu-slideshow-selector");a("#bu_slideshow_modal_button").on("click",function(){k.open()}),a("#bu_slideshow_modal_wrap").on("click","#bu_insert_slideshow",function(a){var b,c;return l.ui.parent().find(".error").remove(),b=l.getOptions(),parseInt(b.show_id)?(c='[bu_slideshow show_id="'+b.show_id+'" show_nav="'+b.show_nav+'" transition="'+b.transition+'" nav_style="'+b.nav_style+'" autoplay="'+b.autoplay+'" transition_delay="'+b.transition_delay+'" width="'+b.width+'" shuffle="'+b.shuffle+'"]',window.send_to_editor("<br />"+c+"<br />"),l.reset(),k.close(),!1):(f(buSlideshowLocalAdmin.noneSelectedError,l.ui.parent()),!1)})}j.length&&(a(".bu-slideshow-slide:first-child").addClass("open"),a("#bu-slideshow-slidelist").on("click",".bu-slide-expand",function(){var b=a(this).parents(".bu-slideshow-slide").first(),c=b.find(".bu-slide-edit-container");return b.hasClass("open")?(b.removeClass("open"),c.slideUp(300)):(b.addClass("open"),c.slideDown(300)),!1}),a("#bu-slideshow-slidelist").on("keyup",".bu-slideshow-title-input",function(){var b=a(this);b.parents(".bu-slideshow-slide").find(".bu-slide-title").text(b.val())}),a("#bu-slideshow-editform").on("submit",function(){return a("#bu_slideshow_name").val().replace(" ","")?!window.reindexingSlides:(f(buSlideshowLocalAdmin.emptyNameError,a(this)),!1)}),a("#bu-slideshow-slidelist ul").sortable({stop:b,placeholder:"sortable-placeholder",start:c}),a("#bu-slideshow-add-slide").on("click",function(){return d(j.find("#bu-slideshow-slidelist li").length),!1}),a("#bu-slideshow-slidelist").on("click",".bu-slide-delete-button",function(){return confirm(buSlideshowLocalAdmin.deleteConfirmSlide)&&(a(this).parents().parent(".bu-slideshow-slide").remove(),b()),!1}),window.buUploaders={init:function(b){var c=a(b);if(!c.length)throw new TypeError("No valid button identified.");this.slide=c.parents(".bu-slideshow-slide"),this.populateFields()},populateFields:function(){this.addButton=this.slide.find(".bu-slideshow-add-img"),this.removeButton=this.slide.find(".bu-slideshow-remove-img"),this.imgIdField=this.slide.find(".bu-slideshow-img-id"),this.imgSizeField=this.slide.find(".bu-slideshow-img-size"),this.imgMeta=this.slide.find(".bu-slide-meta"),this.thumbContainers=this.slide.find(".bu-slide-thumb, .bu-slide-header-thumb")},select:function(){this.newHandleImageSelect()},remove:function(){this.thumbContainers.each(function(b,c){a(c).find("img").remove()}),this.imgIdField.val(""),this.imgSizeField.val(""),this.imgMeta.hide(),this.removeButton.hide()},handleImgThumbResponse:function(b){var c,d;b&&"0"!==b?(this.thumbContainers.each(function(e,f){d=a(f),c=d.find("img"),c.length?c.replaceWith(b):d.append(b)}),this.removeButton.show()):f(buSlideshowLocalAdmin.thumbFailError,this.slide.find(".bu-slide-edit-container"),!0)},newHandleImageSelect:function(){var a=this;"object"!=typeof buUploadFrame&&(a.modifyWPSelectFrame(),buUploadFrame=wp.media.frames.bu_slideshow_frame=wp.media({frame:"select",state:"bu-slideshow-image",states:[new wp.media.controller.BuSlideshowImage],button:{text:buSlideshowLocalAdmin.mediaUploadButton},library:{type:"image"}}),buUploadFrame.state("bu-slideshow-image").on("select",function(){var b,c,d;b=this.get("selection").first(),c=this.display(b).attributes,d=b.toJSON().id,a.getImgThumb(d),a.setImageDetails(d,c.size),a.slide.find(".bu-slide-meta").hide()})),buUploadFrame.open()},modifyWPSelectFrame:function(){wp.media.controller.BuSlideshowImage=wp.media.controller.Library.extend({defaults:_.defaults({id:"bu-slideshow-image",library:wp.media.query({type:"image"}),multiple:!1,priority:60,displaySettings:!0,displayUserSettings:!0,title:buSlideshowLocalAdmin.mediaUploadTitle},wp.media.controller.Library.prototype.defaults)})},getImgThumb:function(b){var c,d=this;c={action:"bu_get_slide_thumb",image_id:b},a.post(ajaxurl,c,function(a){d.handleImgThumbResponse(a)})},setImageDetails:function(a,b){this.imgIdField.val(a),this.imgSizeField.val(b)}},a("#bu-slideshow-slidelist").on("click",".bu-slideshow-add-img",function(a){return window.buUploaders.init(this),window.buUploaders.select(),!1}),a("#bu-slideshow-slidelist").on("click",".bu-slideshow-remove-img",function(){return window.buUploaders.init(this),window.buUploaders.remove(),!1}),a("#bu-slideshow-slidelist .bu-slideshow-add-img").each(function(){e(a(this))})),a("#bu_slideshow_show_nav").on("click",function(){a(".bu_slideshow_nav_style").toggle()})})}(jQuery);